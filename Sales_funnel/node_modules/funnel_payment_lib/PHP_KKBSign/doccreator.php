<?php

	/* --------------------------------------------
	    KKBSign class
		-------------
		by Kirsanov Anton (webcompass@list.ru)
		01.06.2006	
	   ------------------------------------------*/
	require_once("kkbsign.class.php");

	function preparedocument($security, $shop, $order){
		// -----------------------------------------------------------------------------------------------------------------
		// ���������

		define("MERCHANT_CERT_ID",	$security['cert_id']);	// �������� ����� �����������
		define("MERCHANT_NAME",		$shop['shopname']);	// �������� �������� (��������)
		define("MERCHANT_ID",		$shop['merchant_id']);			// ID �������� � �������
		define("ORDER_ID",			$order['id']);		// ���������� ����� ������
		define("CURRENCY",			$order['currency']);			// ID ������. 840 - USD
		define("AMOUNT", 			$order['amount']);			// ����� ������


		// -----------------------------------------------------------------------------------------------------------------
		// Include ������


		// -----------------------------------------------------------------------------------------------------------------
		// �������� �������

		$kkb = new KKBSign();

		// -----------------------------------------------------------------------------------------------------------------
		// �������������� ����

		$kkb->invert();

		// -----------------------------------------------------------------------------------------------------------------
		// ��������� ��������� ����.  "����", "������"

		$kkb->load_private_key($security['prvkey'], $security['passphrase']);


		// -----------------------------------------------------------------------------------------------------------------
		// ������ ������

		$merchant = '<merchant cert_id="%certificate%" name="%merchant_name%"><order order_id="%order_id%" amount="%amount%" currency="%currency%"><department merchant_id="%merchant_id%" amount="%amount%"/></order></merchant>';

		// -----------------------------------------------------------------------------------------------------------------
		// ���������� ������ ������, ��������� �������

		$merchant = preg_replace('/\%certificate\%/', 		MERCHANT_CERT_ID , 	$merchant);
		$merchant = preg_replace('/\%merchant_name\%/', 	MERCHANT_NAME , 	$merchant);
		$merchant = preg_replace('/\%order_id\%/', 			ORDER_ID, 			$merchant);
		$merchant = preg_replace('/\%currency\%/', 			CURRENCY, 			$merchant);
		$merchant = preg_replace('/\%merchant_id\%/', 		MERCHANT_ID, 		$merchant);
		$merchant = preg_replace('/\%amount\%/', 			AMOUNT,				$merchant);

		// -----------------------------------------------------------------------------------------------------------------
		// �������������� �������

		$merchant_sign = '<merchant_sign type="RSA">'.$kkb->sign64($merchant).'</merchant_sign>';


		// -----------------------------------------------------------------------------------------------------------------
		// ���������� �����

		$xml = "<document>".$merchant.$merchant_sign."</document>";


		// -----------------------------------------------------------------------------------------------------------------
		// ������� �����

		return $xml;

		// -----------------------------------------------------------------------------------------------------------------
		// echo base64_encode($xml); // ������� ����� ��� ���������� Signed_Order_B64
	}

	function verify($security, $xml){

		$kkb = new KKBSign();
		$kkb->invert();
		if (!$kkb->load_private_key($security['prvkey'],$security['passphrase'])){
			if ($kkb->ecode>0){
				//echo $kkb->estatus;
				return $kkb->estatus;
			};
		};
		$banksign = $kkb->sign($xml);
		$banksign = base64_decode($banksign);
		//$banksign = 'd8KaC5wa7KJMQDnhu+v0i/NFmD8ghoJIsT6h77HAobGMr4aOZGGofDr1LDuD6zoSZE2OIKRo+MY3gkHTq7aYgF4GKn5uht1DzzGBoYtIXyVMbxcbWkHQn/YQBw2C1IDHD2zewIX0N9P4jvCuOB8sQyoQjNb9H5PPz0nqdor86vGeDAU=';
		return $kkb->check_sign($xml, $banksign, $security['pubkey']);
	}

	function createsign($security, $xml){
		$sign = 'xjJwgeLAyWssZr3/gS7TI/xaajoF3USk0B/ZfLv6SYyY/3H8tDHUiyGcV7zDO5+rINwBoTn7b9BrnO/kvQfebIhHbDlCSogz2cB6Qa2ELKAGqs8aDZDekSJ5dJrgmFT6aTfgFgnZRmadybxTMHGR6cn8ve4m0TpQuaPMQmKpxTI=';
		$kkb = new KKBSign();
		$kkb->invert();
		$kkb->load_private_key($security['prvkey'],$security['passphrase']);
		$ret = $kkb->sign($xml, $sign);
		return $ret;
	}

	function parse_xml($xml){
		$xml_parser = new SimpleXMLElement($xml);
		//$result = $xml_parser->parse($xml);
		return $xml_parser->bank;
	}

	function get_bank_node($xmlstr){
		$xml_parser = new SimpleXMLElement($xmlstr);
        return $xml_parser->bank->asXML();
	}

	function get_bank_sign_node($xmlstr){
    		$xml_parser = new SimpleXMLElement($xmlstr);
            return $xml_parser->bank_sign;
    }

?>