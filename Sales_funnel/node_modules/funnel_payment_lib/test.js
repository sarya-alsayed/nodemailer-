/**
 * Created by daulet on 7/29/16.
 */
var path = require('path');
var Service = require('./service');
var Q = require('q');
var SYSOPTIONS = {
    security: {
        cert_id : "00C182B189",
        prvkey:  path.join(process.env.HOME, "www/security/epay", "test_prv.pem"),
        pubkey: path.join(process.env.HOME, "www/security/epay", "rootCA1.pub"),
        passphrase: "nissan"
    },
    shop: {
        shopname: "Test shop",
        merchant_id: "92061101"
    }
};

var payservice = new Service(SYSOPTIONS);
var order = payservice.takeOrder({
    email: "SeFrolov@kkb.kz",
    id: "0728132926",
    currency: "840",
    amount: "500"
});

console.info("INFO: security keys=>", SYSOPTIONS.security);

if(!order) {
    console.error("INFO: Order must be filled on 100%. Stop Test");
    process.exit(-1);
}
/*************   ENCRYPT  ******************/
payservice
    .createPaymentDocument()
    .then(console.log.bind(console, "Ready Payment Document=>"))
    .catch(function (err) {
        console.error("CATCH SERVICE ERROR! mes:",err);
    })
    .done(function () {
        console.info("INFO: Creating Payment Doc complete/ This test well done!");
        console.info("------------------------")
    });

/*******************   VERIFY  ************************/
var XMLStruct = '<document><bank name="Kazkommertsbank JSC"><customer name="Ucaf Test Maest" mail="SeFrolov@kkb.kz" phone="">' +
    '<merchant cert_id="00C182B189" name="test merch"><order order_id="0706172110" amount="1000" currency="398">' +
    '<department merchant_id="92056001" amount="1000"/></order></merchant><merchant_sign type="RSA"/></customer>' +
    '<customer_sign type="RSA"/><results timestamp="2006-07-06 17:21:50"><payment merchant_id="92056001" amount="1000" ' +
    'reference="618704198173" approval_code="447753" response_code="00"/></results></bank>' +
    '<bank_sign cert_id="00c183d690" type="SHA/RSA">' +
    'KswGXFfmYMw1QROTtWXWbQ2NOVNRwIMHzKLg/BmWKlYTFivu3qTy7vetPFS9ny4qAYmy2xXw2EArkcRdCCc6v27xg4j9EE8H7eACHdd9VT227vKhPWtWa9kPEEm4hg2/XwSyQQeipWrHMG7b79xHoSKaJ1u3wUcwIJybEzJOY0ly9IU=' +
    '</bank_sign>' +
    '</document>';
var sign = "";

//var bankXML = '<merchant cert_id="00C182B189" name="Test shop"><order order_id="0728132926" amount="500" currency="840"><department merchant_id="92061101" amount="500"/></order></merchant>';
//var sign = "oeiXFQhI6KtkSMB7ycfdE71GAXymifFjdd/2XkXZ9Xz0g6qEGUQ6sj1ZwPXYi3ORIBpFdRnu5/kwJSdKD/9tlw==";

console.log('---------------------------');

/*************   PARSING  ******************/
Q.all([
    payservice.getBankChildElement(XMLStruct),
    payservice.getBankSignChildElement(XMLStruct)])
    .then(payservice.signVerify.bind(payservice))
    .then(console.info.bind(console, "INFO: Verify Test complete/"))
    .then(payservice.parseXMLDocument.bind(payservice, XMLStruct))
    .then(payservice.getReadyOrder)
    .then(function (orderAsJson) {
        console.log("Order ID",orderAsJson["@attributes"]["order_id"])
    })
    .catch(console.error.bind(console));